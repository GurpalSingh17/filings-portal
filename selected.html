<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>The Stuff We Actually Need</title>

  <!-- DataTables core CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"
  />
  <!-- Buttons extension CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css"
  />
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    nav a { margin-right: .5rem; }
    label, select { display: block; margin: .5rem 0; }
  </style>
</head>
<body>
  <nav>
    <a href="index.html">Home</a> |
    <a href="selected.html"><strong>Selected Data</strong></a>
  </nav>

  <h1>The Stuff We Actually Need</h1>

  <label for="typeFilter">Filter by Filings (multi-select):</label>
  <select id="typeFilter" multiple style="width: 200px; height: 8em;"></select>

  <table id="selected" class="display" width="100%">
    <thead><tr></tr></thead>
    <tbody></tbody>
  </table>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <!-- DataTables -->
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <!-- Buttons extension -->
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <!-- PapaParse for CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <script>
  $(function() {
    // 1) Parse the CSV
    Papa.parse('selected_data.csv', {
      download: true,
      header: true,
      complete: function(results) {
        const data = results.data;
        const fields = results.meta.fields;

        // 2) Build the multi-select filter from unique Type values
        const types = Array.from(new Set(data.map(r => r.Type))).sort();
        const $filter = $('#typeFilter');
        types.forEach(t => {
          $filter.append(`<option value="${t}">${t}</option>`);
        });

        // 3) Set up DataTables columns, using a function for data: to avoid
        //    the “unknown parameter” DataTables warning on header names
        const columns = fields.map(f => ({
          title: f,
          data: row => row[f],
          render: (d, _, __) => {
            if (f === 'Link' || f === 'Source File') {
              return `<a href="${d}" target="_blank">${d}</a>`;
            }
            if (f === 'Parsed CSV') {
              // open our CSV viewer instead of forcing a download
              const url = `view.html?file=${encodeURIComponent(d)}`;
              return `<a href="${url}" target="_blank">view</a>`;
            }
            return d;
          }
        }));

        // 4) Initialize DataTable with CSV/Excel buttons
        const table = $('#selected').DataTable({
          data,
          columns,
          dom: 'Bfrtip',
          buttons: [
            { extend: 'csvHtml5', title: 'selected_data' },
            { extend: 'excelHtml5', title: 'selected_data' }
          ],
          pageLength: 25,
          order: []
        });

        // 5) Wire up the filter: regex OR on selected Types
        $filter.on('change', function() {
          const vals = $(this).val() || [];
          if (vals.length === 0) {
            table.column(fields.indexOf('Type')).search('').draw();
          } else {
            // join with | and use regex search
            const regex = vals.join('|');
            table.column(fields.indexOf('Type'))
                 .search(regex, true, false)
                 .draw();
          }
        });
      },

      error: function(err) {
        $('body').prepend(
          `<p style="color:red">Error loading CSV: ${err}</p>`
        );
      }
    });
  });
  </script>
</body>
</html>
